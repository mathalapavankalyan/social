package com.user.service;

import org.bson.types.ObjectId;
import org.springframework.data.mongodb.gridfs.GridFsResource;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import com.user.collection.User;
import com.user.helper.GridService;
import com.user.repository.UserRepository;

import lombok.AllArgsConstructor;

@Service
@AllArgsConstructor
public class UserService {
	
	private final GridService gridService;
	
	private final UserRepository userRepository;

	public  String uploadProfilePicture(ObjectId userId, MultipartFile profilePictureFile) {
		
		User user = userRepository.findById(userId).orElseThrow(()->new RuntimeException("User Not found"));
		
		if(user.getProfilePictureId() != null) {
			gridService.deleteFile(user.getProfilePictureId());
		}
		ObjectId fileId = gridService.saveFile(profilePictureFile);
		user.setProfilePictureId(fileId);
		return "profile photo saved Successfully!!";
	}

	public GridFsResource getProfileImage(ObjectId userId) {

	    User user = userRepository.findById(userId)
	            .orElseThrow(() -> new RuntimeException("User not found"));

	    if (user.getProfilePictureId() == null) {
	        throw new RuntimeException("User has no profile picture");
	    }

	    return gridService.getFile(user.getProfilePictureId());
	}

}
